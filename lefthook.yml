# Lefthook configuration for React on Rails Demos monorepo
# https://github.com/evilmartians/lefthook

pre-commit:
  parallel: true
  commands:
    trailing-newline:
      glob: '*.{rb,js,ts,jsx,tsx,yml,yaml,json,md,sh}'
      run: |
        for file in {staged_files}; do
          if [ -f "$file" ]; then
            # Check if file ends with newline
            if [ -n "$(tail -c 1 "$file")" ]; then
              echo "‚ùå Missing trailing newline: $file"
              # Add trailing newline
              echo "" >> "$file"
              git add "$file"
              echo "‚úÖ Added trailing newline to: $file"
            fi
          fi
        done

    rubocop:
      glob: '*.rb'
      run: bundle exec rubocop --force-exclusion {staged_files}
      stage_fixed: true

commit-msg:
  commands:
    check-message:
      run: |
        # Ensure commit message is not empty
        if ! grep -q '[^[:space:]]' {1}; then
          echo "‚ùå Commit message cannot be empty"
          exit 1
        fi

pre-push:
  commands:
    check-local-gems:
      run: |
        echo "üîç Checking for local gem paths in Gemfiles and package.json files..."

        # Check for local gem paths in Gemfiles
        if git diff --name-only origin/main...HEAD | grep -E 'Gemfile$' | xargs -I {} git diff origin/main...HEAD -- {} | grep -E '^\+.*gem.*path:'; then
          echo ""
          echo "‚ùå ERROR: Found local gem paths in Gemfile(s)"
          echo ""
          echo "You're trying to push changes with local gem paths (path: '...')."
          echo "This usually means you forgot to restore after using bin/use-local-gems."
          echo ""
          echo "To fix:"
          echo "  1. Run: bin/use-local-gems --restore"
          echo "  2. Or manually edit the Gemfile(s) to use version constraints"
          echo ""
          exit 1
        fi

        # Check for file: protocol in package.json files
        if git diff --name-only origin/main...HEAD | grep -E 'package\.json$' | xargs -I {} git diff origin/main...HEAD -- {} | grep -E '^\+.*"file:'; then
          echo ""
          echo "‚ùå ERROR: Found local file: paths in package.json file(s)"
          echo ""
          echo "You're trying to push changes with local npm package paths (file:...)."
          echo "This usually means you forgot to restore after using bin/use-local-gems."
          echo ""
          echo "To fix:"
          echo "  1. Run: bin/use-local-gems --restore"
          echo "  2. Or manually edit the package.json file(s) to use version constraints"
          echo ""
          exit 1
        fi

        echo "‚úÖ No local gem paths found"
