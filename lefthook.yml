# Lefthook configuration for React on Rails Demos monorepo
# https://github.com/evilmartians/lefthook

pre-commit:
  parallel: true
  commands:
    trailing-newline:
      glob: '*.{rb,js,ts,jsx,tsx,yml,yaml,json,md,sh}'
      run: |
        for file in {staged_files}; do
          if [ -f "$file" ]; then
            # Check if file ends with newline
            if [ -n "$(tail -c 1 "$file")" ]; then
              echo "‚ùå Missing trailing newline: $file"
              # Add trailing newline
              echo "" >> "$file"
              git add "$file"
              echo "‚úÖ Added trailing newline to: $file"
            fi
          fi
        done

    rubocop:
      glob: '*.rb'
      # Use bin/mise-exec to ensure correct Ruby version from .tool-versions
      # Run rubocop from demo directories for demo files (each has its own config)
      run: |
        root_files=""
        # Run RuboCop on root files
        for file in {staged_files}; do
          if [[ ! "$file" == demos/* ]]; then
            root_files+="$file "
          fi
        done
        if [ -n "$root_files" ]; then
          echo "Running RuboCop on root files..."
          bin/mise-exec bundle exec rubocop --autocorrect --force-exclusion $root_files
        fi

        # Run RuboCop on demo files from within each demo directory
        demo_files=$(echo "{staged_files}" | tr ' ' '\n' | grep '^demos/' || true)
        if [ -n "$demo_files" ]; then
          for file in $demo_files; do
            demo_dir=$(echo "$file" | cut -d'/' -f1-2)
            rel_file=$(echo "$file" | sed "s|^$demo_dir/||")
            if [ -f "$demo_dir/Gemfile" ]; then
              echo "Running RuboCop in $demo_dir for $rel_file"
              (cd "$demo_dir" && ../../bin/mise-exec bundle exec rubocop --autocorrect --force-exclusion "$rel_file" && git add "$rel_file")
            fi
          done
        fi
      stage_fixed: true

    eslint:
      glob: '*.{js,jsx,ts,tsx}'
      exclude: 'node_modules/**/*'
      run: |
        # Run ESLint on staged files in demos
        demo_files=$(echo "{staged_files}" | tr ' ' '\n' | grep '^demos/' || true)
        if [ -n "$demo_files" ]; then
          for file in $demo_files; do
            # Determine which demo this file belongs to
            demo_dir=$(echo "$file" | cut -d'/' -f1-2)
            rel_file=$(echo "$file" | sed "s|^$demo_dir/||")
            if [ -f "$demo_dir/package.json" ]; then
              echo "Running ESLint in $demo_dir for $rel_file"
              (cd "$demo_dir" && npx eslint --fix "$rel_file" && git add "$rel_file")
            fi
          done
        fi

    prettier:
      glob: '*.{js,jsx,ts,tsx,json,css,scss,md}'
      exclude: 'node_modules/**/*'
      run: |
        # Run Prettier on staged files in demos
        demo_files=$(echo "{staged_files}" | tr ' ' '\n' | grep '^demos/' || true)
        if [ -n "$demo_files" ]; then
          for file in $demo_files; do
            # Determine which demo this file belongs to
            demo_dir=$(echo "$file" | cut -d'/' -f1-2)
            rel_file=$(echo "$file" | sed "s|^$demo_dir/||")
            if [ -f "$demo_dir/package.json" ]; then
              echo "Running Prettier in $demo_dir for $rel_file"
              (cd "$demo_dir" && npx prettier --write "$rel_file" && git add "$rel_file")
            fi
          done
        fi

commit-msg:
  commands:
    check-message:
      run: |
        # Ensure commit message is not empty
        if ! grep -q '[^[:space:]]' {1}; then
          echo "‚ùå Commit message cannot be empty"
          exit 1
        fi

pre-push:
  commands:
    check-local-gems:
      run: |
        echo "üîç Checking for local gem paths in Gemfiles and package.json files..."

        # Simple approach: check uncommitted/staged changes and recent commits on current branch
        # Compare current branch with its remote tracking branch, or origin/main if no tracking branch
        current_branch=$(git rev-parse --abbrev-ref HEAD)
        remote_branch=$(git rev-parse --abbrev-ref --symbolic-full-name @{u} 2>/dev/null || echo "origin/main")

        # Check for local gem paths in Gemfiles (in commits being pushed)
        if git diff --name-only "$remote_branch"...HEAD 2>/dev/null | grep -qE 'Gemfile$'; then
          # Check for local gem paths, but exclude shakacode_demo_common which is intentionally local
          local_gem_lines=$(git diff "$remote_branch"...HEAD -- '*/Gemfile' 'Gemfile' 2>/dev/null | grep -E '^\+.*gem.*path:' | grep -v 'shakacode_demo_common' || true)
          if [ -n "$local_gem_lines" ]; then
            echo ""
            echo "=========================================="
            echo "‚ùå ERROR: Found local gem paths in Gemfile(s)"
            echo "=========================================="
            echo ""
            echo "You're trying to push changes with local gem paths (path: '...')."
            echo "This usually means you forgot to restore after using bin/swap-deps."
            echo ""
            echo "üìã Detected local gem paths:"
            echo "$local_gem_lines" | sed 's/^+/  /'
            echo ""
            echo "üîç Affected files:"
            git diff --name-only "$remote_branch"...HEAD -- '*/Gemfile' 'Gemfile' 2>/dev/null | sed 's/^/  /'
            echo ""
            echo "üí° To fix:"
            echo "  1. Check if you used bin/swap-deps for local development:"
            echo "     bin/swap-deps --status"
            echo ""
            echo "  2. If yes, restore the original dependencies:"
            echo "     bin/swap-deps --restore"
            echo ""
            echo "  3. If you didn't use swap-deps, manually edit the Gemfile(s)"
            echo "     to use version constraints instead of local paths"
            echo ""
            echo "  4. After fixing, stage the changes and try pushing again"
            echo ""
            echo "‚ÑπÔ∏è  Note: shakacode_demo_common is allowed as a local path"
            echo "=========================================="
            echo ""
            exit 1
          fi
        fi

        # Check for file: protocol in package.json files (in commits being pushed)
        if git diff --name-only "$remote_branch"...HEAD 2>/dev/null | grep -qE 'package\.json$'; then
          # Check for local file: paths, but exclude shakacode_demo_common which is intentionally local
          local_npm_lines=$(git diff "$remote_branch"...HEAD -- '*/package.json' 'package.json' 2>/dev/null | grep -E '^\+.*"file:' | grep -v 'shakacode_demo_common' || true)
          if [ -n "$local_npm_lines" ]; then
            echo ""
            echo "=========================================="
            echo "‚ùå ERROR: Found local file: paths in package.json file(s)"
            echo "=========================================="
            echo ""
            echo "You're trying to push changes with local npm package paths (file:...)."
            echo "This usually means you forgot to restore after using bin/swap-deps."
            echo ""
            echo "üìã Detected local file: paths:"
            echo "$local_npm_lines" | sed 's/^+/  /'
            echo ""
            echo "üîç Affected files:"
            git diff --name-only "$remote_branch"...HEAD -- '*/package.json' 'package.json' 2>/dev/null | sed 's/^/  /'
            echo ""
            echo "üí° To fix:"
            echo "  1. Check if you used bin/swap-deps for local development:"
            echo "     bin/swap-deps --status"
            echo ""
            echo "  2. If yes, restore the original dependencies:"
            echo "     bin/swap-deps --restore"
            echo ""
            echo "  3. If you didn't use swap-deps, manually edit the package.json file(s)"
            echo "     to use version constraints instead of local file: paths"
            echo ""
            echo "  4. After fixing, stage the changes and try pushing again"
            echo ""
            echo "‚ÑπÔ∏è  Note: shakacode_demo_common is allowed as a local path"
            echo "=========================================="
            echo ""
            exit 1
          fi
        fi

        echo "‚úÖ No local gem or file paths found (shakacode_demo_common excluded)"
