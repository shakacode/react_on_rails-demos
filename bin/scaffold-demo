#!/usr/bin/env ruby
# frozen_string_literal: true

require "bundler/setup"
require_relative "../lib/demo_scripts"
require "optparse"

options = {
  shakapacker_version: nil,
  react_on_rails_version: nil,
  typescript: false,
  tailwind: false,
  bootstrap: false,
  mui: false,
  skip_install: false,
  skip_db: false,
  dry_run: false
}

parser = OptionParser.new do |opts|
  opts.banner = "Usage: bin/scaffold-demo DEMO_NAME [options]"
  opts.separator ""
  opts.separator "Example: bin/scaffold-demo react_on_rails-demo-v16-ssr-hmr"
  opts.separator ""
  opts.separator "Options:"

  opts.on("--typescript", "Enable TypeScript support") do
    options[:typescript] = true
  end

  opts.on("--tailwind", "Add Tailwind CSS") do
    options[:tailwind] = true
  end

  opts.on("--bootstrap", "Add Bootstrap") do
    options[:bootstrap] = true
  end

  opts.on("--mui", "Add Material-UI") do
    options[:mui] = true
  end

  opts.on("--skip-install", "Skip npm/yarn install") do
    options[:skip_install] = true
  end

  opts.on("--skip-db", "Skip database creation") do
    options[:skip_db] = true
  end

  opts.on("--dry-run", "Show commands that would be executed without running them") do
    options[:dry_run] = true
  end

  opts.on("--shakapacker-version VERSION", "Shakapacker version") do |v|
    options[:shakapacker_version] = v
  end

  opts.on("--react-on-rails-version VERSION", "React on Rails version") do |v|
    options[:react_on_rails_version] = v
  end

  opts.on("-h", "--help", "Show this help message") do
    puts opts
    exit
  end
end

begin
  parser.parse!

  if ARGV.empty?
    puts parser
    exit 1
  end

  demo_name = ARGV[0]

  scaffolder = DemoScripts::DemoScaffolder.new(
    demo_name: demo_name,
    **options
  )

  scaffolder.create!
rescue DemoScripts::Error => e
  warn "Error: #{e.message}"
  exit 1
rescue OptionParser::InvalidOption => e
  warn e.message
  puts parser
  exit 1
end