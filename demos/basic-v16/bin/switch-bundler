#!/usr/bin/env ruby
# frozen_string_literal: true

# Script to switch between webpack and rspack bundlers
# Usage: bin/switch-bundler [webpack|rspack]

require "yaml"
require "fileutils"

SHAKAPACKER_CONFIG = "config/shakapacker.yml"

def current_bundler
  config = YAML.load_file(SHAKAPACKER_CONFIG, aliases: true)
  config.dig("default", "assets_bundler") || "webpack"
end

def switch_to(bundler)
  unless %w[webpack rspack].include?(bundler)
    puts "❌ Invalid bundler: #{bundler}"
    puts "   Usage: bin/switch-bundler [webpack|rspack]"
    exit 1
  end

  current = current_bundler
  if current == bundler
    puts "✅ Already using #{bundler}"
    exit 0
  end

  # Update shakapacker.yml
  config = YAML.load_file(SHAKAPACKER_CONFIG, aliases: true)
  config["default"] ||= {}
  config["default"]["assets_bundler"] = bundler

  # Also update javascript_transpiler recommendation
  if bundler == "rspack"
    config["default"]["javascript_transpiler"] = "swc" unless config["default"]["javascript_transpiler"] == "swc"
  end

  File.write(SHAKAPACKER_CONFIG, YAML.dump(config))

  puts "✅ Switched from #{current} to #{bundler}"
  puts ""
  puts "📝 Configuration updated in #{SHAKAPACKER_CONFIG}"
  puts ""

  if bundler == "rspack"
    puts "🔧 Recommended next steps for rspack:"
    puts "   1. Ensure rspack dependencies are installed:"
    puts "      - @rspack/core"
    puts "      - @rspack/cli"
    puts "      - @rspack/plugin-react-refresh (for React Fast Refresh)"
    puts "      - rspack-manifest-plugin"
    puts ""
    puts "   2. Remove webpack-specific dependencies if desired:"
    puts "      - webpack"
    puts "      - webpack-cli"
    puts "      - webpack-dev-server"
    puts "      - @pmmmwh/react-refresh-webpack-plugin"
    puts ""
    puts "   3. Restart your dev server:"
    puts "      bin/dev"
  else
    puts "🔧 Recommended next steps for webpack:"
    puts "   1. Ensure webpack dependencies are installed:"
    puts "      - webpack"
    puts "      - webpack-cli"
    puts "      - webpack-dev-server"
    puts "      - @pmmmwh/react-refresh-webpack-plugin (for React Fast Refresh)"
    puts ""
    puts "   2. Remove rspack-specific dependencies if desired:"
    puts "      - @rspack/core"
    puts "      - @rspack/cli"
    puts "      - @rspack/plugin-react-refresh"
    puts "      - rspack-manifest-plugin"
    puts ""
    puts "   3. Restart your dev server:"
    puts "      bin/dev"
  end
  puts ""
  puts "💡 Tip: Both webpack and rspack can coexist in package.json during migration"
end

if ARGV.empty?
  puts "Current bundler: #{current_bundler}"
  puts ""
  puts "Usage: bin/switch-bundler [webpack|rspack]"
  exit 0
else
  switch_to(ARGV[0])
end
